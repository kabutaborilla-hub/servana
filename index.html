<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saravana Sales CRM</title>
    
    <!-- 1. Loads Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Loads Supabase client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- 3. Google Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- 4. Custom styles for the app -->
    <style>
        /* --- New v6 "Graphite" Theme --- */
        :root {
            --color-primary: 59, 130, 246; /* blue-500 */
            --color-primary-light: 239, 246, 255; /* blue-50 */
            --color-primary-dark: 30, 64, 175; /* blue-800 */
            
            --color-text-primary: 15, 23, 42; /* slate-900 */
            --color-text-secondary: 51, 65, 85; /* slate-700 */
            --color-text-muted: 100, 116, 139; /* slate-500 */

            --color-bg: 248, 250, 252; /* slate-50 */
            --color-card-bg: 255, 255, 255;
            --color-border: 226, 232, 240; /* slate-200 */
            --color-input-bg: 241, 245, 249; /* slate-100 */
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text-secondary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        h1, h2, h3, h4, h5, h6 {
            color: var(--color-text-primary);
        }

        /* Custom Tailwind classes */
        .primary-bg { background-color: rgb(var(--color-primary)); }
        .primary-text { color: rgb(var(--color-primary)); }
        .primary-text-dark { color: var(--color-primary-dark); }
        .primary-bg-light { background-color: var(--color-primary-light); }
        
        /* Custom modal styles */
        #modal-backdrop {
            display: none;
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 40;
        }
        #modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
        }

        /* Custom Loader */
        #loader {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 60;
        }
        .spinner {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            padding: 3px;
            background: conic-gradient(#0000 10%, rgb(var(--color-primary))) 
                        mask;
            -webkit-mask: radial-gradient(farthest-side,#0000 calc(100% - 6px),#000 0);
            mask: radial-gradient(farthest-side,#0000 calc(100% - 6px),#000 0);
            animation: spin 1s infinite linear;
        }
        @keyframes spin {
            to { transform: rotate(1turn); }
        }

        /* Kanban Drag Styling */
        .kanban-column {
            scroll-snap-align: start;
            flex: 0 0 90%; /* Each column takes 90% of viewport */
        }
        @media (min-width: 768px) {
            .kanban-column {
                flex: 0 0 320px; /* Fixed width on desktop */
            }
        }
        .kanban-card.dragging {
            opacity: 0.5;
            background: var(--color-primary-light);
            transform: rotate(3deg);
        }
        .kanban-dropzone.drag-over {
            background: var(--color-primary-light);
            border-style: dashed;
        }

        /* Custom Form Input */
        .form-input {
            display: block;
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--color-border);
            border-radius: 0.75rem; /* More rounded */
            background-color: var(--color-input-bg);
            color: var(--color-text-primary);
            font-weight: 500;
            transition: all 0.2s;
        }
        .form-input:focus {
            background-color: var(--color-card-bg);
            box-shadow: 0 0 0 3px rgb(var(--color-primary) / 0.4);
            border-color: rgb(var(--color-primary));
            outline: none;
        }
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--color-text-secondary);
        }

        /* Custom Nav */
        .nav-button.active svg {
            color: rgb(var(--color-primary));
        }
        .nav-button.active span {
            color: rgb(var(--color-primary));
            font-weight: 600;
        }
        
        /* New Audio Recorder Styles */
        #audio-recorder-ui.recording .record-btn-icon {
            display: none;
        }
        #audio-recorder-ui:not(.recording) .stop-btn-icon {
            display: none;
        }
        #audio-recorder-ui.recording #record-btn {
            background-color: #ef4444; /* red-500 */
            color: white;
            animation: pulse 1.5s infinite;
        }
        #audio-playback-player {
            width: 100%;
            height: 40px;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Report Chart Bars */
        .chart-bar {
            background-color: rgb(var(--color-primary) / 0.2);
            position: relative;
            border-radius: 0.25rem 0.25rem 0 0;
            overflow: hidden;
        }
        .chart-bar-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgb(var(--color-primary));
            transition: height 0.5s ease-out;
        }
    </style>
</head>
<body class="pb-24">

    <!-- --- Main Container --- -->
    <div class="container mx-auto max-w-7xl">

        <!-- --- Header --- -->
        <header id="app-header" class="p-4 pt-6 md:px-8 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="p-3 primary-bg text-white rounded-xl shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                </div>
                <h1 class="text-3xl font-bold text-gray-800">
                    Saravana<span class="primary-text">CRM</span>
                </h1>
            </div>
            <button id="back-button" class="hidden text-gray-500 hover:text-gray-900">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                </svg>
            </button>
        </header>

        <!-- --- Loading Spinner --- -->
        <div id="loader">
            <div class="spinner"></div>
        </div>
        
        <!-- --- Error/Message Display --- -->
        <div id="message-bar" class="text-center p-4 m-4 rounded-lg shadow" style="display: none;">
            <!-- Message content goes here -->
        </div>

        <!-- --- Main Content Area --- -->
        <main id="app-content" class="p-4 md:px-8">
            <!-- Dynamic content will be injected by JavaScript -->
        </main>

    </div> <!-- End container -->

    <!-- --- Bottom Navigation --- -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 shadow-inner flex justify-around items-center h-20 md:h-16 z-30">
        
        <button id="nav-dashboard" class="nav-button active flex flex-col items-center justify-center w-full h-full text-slate-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
            </svg>
            <span class="text-xs font-medium mt-1">Dashboard</span>
        </button>
        
        <button id="nav-pipeline" class="nav-button flex flex-col items-center justify-center w-full h-full text-slate-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
            <span class="text-xs font-medium mt-1">Pipeline</span>
        </button>
        
        <button id="nav-add" class="flex flex-col items-center justify-center primary-bg text-white rounded-full h-16 w-16 -mt-8 shadow-lg border-4 border-white hover:opacity-90 transition-opacity">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
            </svg>
        </button>
        
        <button id="nav-search" class="nav-button flex flex-col items-center justify-center w-full h-full text-slate-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <span class="text-xs font-medium mt-1">Search</span>
        </button>
        
        <button id="nav-reports" class="nav-button flex flex-col items-center justify-center w-full h-full text-slate-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
            <span class="text-xs font-medium mt-1">Reports</span>
        </button>
    </nav>
    
    <!-- --- Confirmation Modal --- -->
    <div id="modal-backdrop"></div>
    <div id="modal" class="bg-white rounded-2xl shadow-xl max-w-sm w-11/12 p-6 transition-all transform opacity-0 scale-95">
        <h3 id="modal-title" class="text-xl font-semibold text-gray-900 mb-2">Confirm Action</h3>
        <p id="modal-message" class="text-gray-600 mb-6">Are you sure?</p>
        <div class="flex justify-end space-x-3">
            <button id="modal-cancel-btn" class="px-5 py-2 border border-slate-300 rounded-lg text-slate-700 font-medium hover:bg-slate-50 transition-colors">
                Cancel
            </button>
            <button id="modal-confirm-btn" class="px-5 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition-colors">
                Confirm
            </button>
        </div>
    </div>


    <!-- 5. Main Application JavaScript -->
    <script type="module">
        // --- Supabase Setup ---
        const SUPABASE_URL = 'https://seygsmqucuvnialnuqdv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNleWdzbXF1Y3V2bmlhbG51cWR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzODY1ODMsImV4cCI6MjA3Njk2MjU4M30.5iXFdlkDHVKRjHBTqUiI1SrRpItoLbrTsZVe-9ETiII';
        
        const { createClient } = supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- Constants ---
        const DEAL_STAGES = ['New', 'Contacted', 'Demo', 'Proposal', 'Closed-Won', 'Closed-Lost'];
        const PRIORITIES = ['Hot', 'Warm', 'Cold'];
        const LEAD_SOURCES = ['Walk-in', 'Referral', 'Cold Call', 'Web', 'Other'];
        const PDF_LINK = 'https://servanainfo.onrender.com';
        const AUDIO_BUCKET = 'audio_notes';

        // --- Application State ---
        let state = {
            view: 'dashboard', // 'dashboard', 'pipeline', 'add', 'search', 'reports', 'detail'
            restaurants: [],
            tasks: [],
            audioNotes: [],
            loading: false,
            searchTerm: '',
            currentRestaurantId: null,
            draggedItem: null,
            draggedItemOriginalStage: null,
            // New Audio State
            mediaRecorder: null,
            audioChunks: [],
            recordedAudioBlob: null,
            isRecording: false,
        };

        // --- DOM Elements ---
        const appContent = document.getElementById('app-content');
        const loader = document.getElementById('loader');
        const messageBar = document.getElementById('message-bar');
        const navButtons = document.querySelectorAll('.nav-button');
        const backButton = document.getElementById('back-button');
        const header = document.getElementById('app-header');
        
        // Modal elements
        const modal = document.getElementById('modal');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');

        // --- State Management ---
        function setState(newState) {
            state = { ...state, ...newState };
            render();
        }

        // --- Show/Hide UI Elements ---
        function showLoader(isLoading) {
            loader.style.display = isLoading ? 'flex' : 'none';
        }

        function showMessage(message, type = 'success') {
            if (!message) {
                messageBar.style.display = 'none';
                return;
            }
            messageBar.style.display = 'block';
            messageBar.textContent = message;
            messageBar.className = `p-4 m-4 rounded-lg shadow ${
                type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
            }`;
            // Auto-hide
            setTimeout(() => {
                messageBar.style.display = 'none';
            }, 3000);
        }
        
        function showConfirm({ title, message, onConfirm }) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modal.style.display = 'block';
            modalBackdrop.style.display = 'block';
            // Animate in
            setTimeout(() => {
                modal.classList.add('opacity-100', 'scale-100');
                modal.classList.remove('opacity-0', 'scale-95');
            }, 10);

            // Use .cloneNode(true) to remove old event listeners
            const newConfirmBtn = modalConfirmBtn.cloneNode(true);
            modalConfirmBtn.parentNode.replaceChild(newConfirmBtn, modalConfirmBtn);
            
            newConfirmBtn.onclick = () => {
                hideConfirm();
                onConfirm();
            };
            
            modalCancelBtn.onclick = hideConfirm;
            modalBackdrop.onclick = hideConfirm;
        }
        
        function hideConfirm() {
            modal.classList.remove('opacity-100', 'scale-100');
            modal.classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                modal.style.display = 'none';
                modalBackdrop.style.display = 'none';
            }, 200);
        }
        
        // --- Navigation ---
        function setupNav() {
            const navMap = {
                'nav-dashboard': 'dashboard',
                'nav-pipeline': 'pipeline',
                'nav-add': 'add',
                'nav-search': 'search',
                'nav-reports': 'reports',
            };
            
            for (const [id, view] of Object.entries(navMap)) {
                document.getElementById(id).onclick = () => {
                    // Stop recording if user navigates away
                    if (state.isRecording) handleStopRecording();
                    
                    // Reset detail view state
                    if (view !== 'detail') {
                        state.currentRestaurantId = null;
                    }
                    setState({ view });
                }
            }
            
            backButton.onclick = () => {
                if (state.currentRestaurantId) {
                    state.currentRestaurantId = null;
                    // Reset audio state
                    state.recordedAudioBlob = null; 
                    setState({ view: 'pipeline' }); // Go back to pipeline by default
                }
            };
        }

        function updateNavActiveState() {
            navButtons.forEach(btn => {
                const view = btn.id.split('-')[1];
                if (view === state.view) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Show/hide back button
            if (state.view === 'detail') {
                backButton.classList.remove('hidden');
                header.classList.add('md:px-4'); // Adjust header padding
            } else {
                backButton.classList.add('hidden');
                header.classList.remove('md:px-4');
            }
        }
        
        // --- Data Fetching ---
        async function fetchAllData() {
            setState({ loading: true });
            try {
                const [restaurantRes, tasksRes, audioNotesRes] = await Promise.all([
                    db.from('restaurants').select('*').order('created_at', { ascending: false }),
                    db.from('tasks').select('*').order('due_date', { ascending: true }),
                    db.from('audio_notes').select('*').order('created_at', { ascending: false })
                ]);

                if (restaurantRes.error) throw restaurantRes.error;
                if (tasksRes.error) throw tasksRes.error;
                if (audioNotesRes.error) throw audioNotesRes.error;

                setState({
                    restaurants: restaurantRes.data || [],
                    tasks: tasksRes.data || [],
                    audioNotes: audioNotesRes.data || [],
                    loading: false
                });
            } catch (err) {
                console.error('Error fetching data:', err);
                showMessage(`Error: ${err.message}`, 'error');
                setState({ loading: false });
            }
        }
        
        // --- Event Handlers (using delegation) ---
        function setupAppListeners() {
            appContent.addEventListener('click', async (e) => {
                const target = e.target;
                const actionEl = target.closest('[data-action]');
                if (!actionEl) return;
                
                const action = actionEl.dataset.action;
                const id = actionEl.dataset.id;

                switch (action) {
                    case 'view-detail':
                        setState({ view: 'detail', currentRestaurantId: id });
                        break;
                    
                    case 'toggle-task':
                        const isCompleted = target.checked;
                        await toggleTask(id, isCompleted);
                        break;
                    
                    case 'delete-task':
                        showConfirm({
                            title: 'Delete Task?',
                            message: 'Are you sure you want to delete this task?',
                            onConfirm: () => deleteTask(id)
                        });
                        break;
                    
                    case 'delete-restaurant':
                        showConfirm({
                            title: 'Delete Restaurant?',
                            message: 'This will delete the restaurant, all its tasks, and all audio notes. This cannot be undone.',
                            onConfirm: () => deleteRestaurant(id)
                        });
                        break;
                    
                    // --- New Audio Actions ---
                    case 'record-audio':
                        handleStartRecording();
                        break;
                    case 'stop-audio':
                        handleStopRecording();
                        break;
                    case 'save-audio':
                        handleSaveAudioNote();
                        break;
                    case 'discard-audio':
                        state.recordedAudioBlob = null;
                        render(); // Just re-render the detail view
                        break;
                    case 'play-audio':
                        const path = actionEl.dataset.path;
                        await playAudioNote(path, actionEl);
                        break;
                    case 'delete-audio':
                        const deletePath = actionEl.dataset.path;
                        showConfirm({
                            title: 'Delete Audio Note?',
                            message: 'Are you sure? This file will be permanently deleted.',
                            onConfirm: () => deleteAudioNote(id, deletePath)
                        });
                        break;
                }
            });
            
            // Form Submissions
            appContent.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                if (e.target.id === 'add-restaurant-form') {
                    await handleAddRestaurant(e.target);
                }
                if (e.target.id === 'add-task-form') {
                    await handleAddTask(e.target);
                }
            });
            
            // Search input (live search)
            appContent.addEventListener('input', (e) => {
                 if (e.target.id === 'search-input') {
                    setState({ searchTerm: e.target.value.toLowerCase() });
                }
            });
            
            // --- Drag and Drop Handlers ---
            appContent.addEventListener('dragstart', (e) => {
                const card = e.target.closest('.kanban-card');
                if (card) {
                    state.draggedItem = card.dataset.id;
                    state.draggedItemOriginalStage = card.closest('.kanban-dropzone').dataset.stage;
                    setTimeout(() => card.classList.add('dragging'), 0);
                }
            });

            appContent.addEventListener('dragend', (e) => {
                const card = e.target.closest('.kanban-card');
                if (card) {
                    card.classList.remove('dragging');
                    state.draggedItem = null;
                    state.draggedItemOriginalStage = null;
                    // Clear all drag-over highlights
                    document.querySelectorAll('.kanban-dropzone').forEach(col => col.classList.remove('drag-over'));
                }
            });

            appContent.addEventListener('dragover', (e) => {
                e.preventDefault();
                const dropzone = e.target.closest('.kanban-dropzone');
                if (dropzone) {
                    dropzone.classList.add('drag-over');
                }
            });
            
            appContent.addEventListener('dragleave', (e) => {
                const dropzone = e.target.closest('.kanban-dropzone');
                if (dropzone) {
                    dropzone.classList.remove('drag-over');
                }
            });

            appContent.addEventListener('drop', (e) => {
                e.preventDefault();
                const dropzone = e.target.closest('.kanban-dropzone');
                if (dropzone && state.draggedItem) {
                    const newStage = dropzone.dataset.stage;
                    dropzone.classList.remove('drag-over');
                    
                    if (newStage !== state.draggedItemOriginalStage) {
                        handleStageUpdate(state.draggedItem, newStage);
                    }
                }
            });
        }
        
        // --- Database Actions ---
        
        async function handleAddRestaurant(form) {
            setState({ loading: true });
            const formData = new FormData(form);
            const newEntry = {
                name: formData.get('name'),
                contact_person: formData.get('contact_person'),
                phone: formData.get('phone'),
                deal_value: parseInt(formData.get('deal_value'), 10) || 0,
                deal_stage: formData.get('deal_stage'),
                priority: formData.get('priority'),
                lead_source: formData.get('lead_source'),
                notes: formData.get('notes'),
                keywords: formData.get('keywords').split(',').map(k => k.trim()).filter(k => k),
            };

            try {
                const { data, error } = await db.from('restaurants').insert([newEntry]).select();
                if (error) throw error;
                
                // Add to local state
                state.restaurants.unshift(data[0]);
                showMessage('Restaurant added successfully!', 'success');
                setState({ view: 'detail', currentRestaurantId: data[0].id, loading: false });
            } catch (err) {
                console.error('Error saving restaurant:', err);
                showMessage(`Error: ${err.message}`, 'error');
                setState({ loading: false });
            }
        }
        
        async function handleAddTask(form) {
            setState({ loading: true });
            const formData = new FormData(form);
            const newTask = {
                restaurant_id: state.currentRestaurantId,
                description: formData.get('description'),
                due_date: formData.get('due_date') || null,
                is_completed: false
            };

            try {
                const { data, error } = await db.from('tasks').insert([newTask]).select();
                if (error) throw error;
                
                // Add to local state
                state.tasks.push(data[0]);
                form.reset(); // Clear the form
                showMessage('Task added!', 'success');
                setState({ loading: false }); // Just re-render
            } catch (err) {
                console.error('Error saving task:', err);
                showMessage(`Error: ${err.message}`, 'error');
                setState({ loading: false });
            }
        }
        
        async function handleStageUpdate(restaurantId, newStage) {
            // Optimistic local update
            const oldRestaurants = [...state.restaurants];
            const newRestaurants = state.restaurants.map(r =>
                r.id == restaurantId ? { ...r, deal_stage: newStage } : r
            );
            setState({ restaurants: newRestaurants });

            try {
                const { error } = await db
                    .from('restaurants')
                    .update({ deal_stage: newStage })
                    .eq('id', restaurantId);
                if (error) throw error;
                showMessage(`Moved to ${newStage}`, 'success');
            } catch (err) {
                console.error('Error updating stage:', err);
                showMessage(`Error: ${err.message}`, 'error');
                setState({ restaurants: oldRestaurants }); // Revert
            }
        }
        
        async function toggleTask(taskId, isCompleted) {
            // Optimistic local update
            const oldTasks = [...state.tasks];
            const newTasks = state.tasks.map(t =>
                t.id == taskId ? { ...t, is_completed: isCompleted } : t
            );
            setState({ tasks: newTasks });
            
            try {
                const { error } = await db
                    .from('tasks')
                    .update({ is_completed: isCompleted })
                    .eq('id', taskId);
                if (error) throw error;
            } catch (err) {
                console.error('Error toggling task:', err);
                showMessage(`Error: ${err.message}`, 'error');
                setState({ tasks: oldTasks }); // Revert
            }
        }
        
        async function deleteTask(taskId) {
            // Optimistic local update
            const oldTasks = [...state.tasks];
            const newTasks = state.tasks.filter(t => t.id != taskId);
            setState({ tasks: newTasks });
            
            try {
                const { error } = await db.from('tasks').delete().eq('id', taskId);
                if (error) throw error;
                showMessage('Task deleted', 'success');
            } catch (err) {
                console.error('Error deleting task:', err);
                showMessage(`Error: ${err.message}`, 'error');
                setState({ tasks: oldTasks }); // Revert
            }
        }

        async function deleteRestaurant(restaurantId) {
            // Optimistic update
            const oldRestaurants = [...state.restaurants];
            const oldTasks = [...state.tasks];
            const oldAudioNotes = [...state.audioNotes]; // Also remove audio notes
            
            const newRestaurants = state.restaurants.filter(r => r.id != restaurantId);
            const newTasks = state.tasks.filter(t => t.restaurant_id != restaurantId);
            const newAudioNotes = state.audioNotes.filter(a => a.restaurant_id != restaurantId);
            
            // Go back to pipeline view
            setState({ 
                restaurants: newRestaurants, 
                tasks: newTasks,
                audioNotes: newAudioNotes,
                view: 'pipeline',
                currentRestaurantId: null
            });
            
            try {
                // DB handles cascade delete for tasks and audio notes
                const { error } = await db.from('restaurants').delete().eq('id', restaurantId);
                if (error) throw error;
                
                // We still need to delete files from storage
                const notesToDelete = oldAudioNotes.filter(a => a.restaurant_id == restaurantId);
                if (notesToDelete.length > 0) {
                    const paths = notesToDelete.map(n => n.storage_path);
                    await db.storage.from(AUDIO_BUCKET).remove(paths);
                }
                
                showMessage('Restaurant deleted', 'success');
            } catch (err) {
                console.error('Error deleting restaurant:', err);
                showMessage(`Error: ${err.message}`, 'error');
                // Revert
                setState({ 
                    restaurants: oldRestaurants, 
                    tasks: oldTasks, 
                    audioNotes: oldAudioNotes, 
                    view: 'detail' 
                });
            }
        }

        // --- NEW: Audio Feature Handlers ---

        async function handleStartRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                state.mediaRecorder = new MediaRecorder(stream);
                state.audioChunks = [];
                state.isRecording = true;
                
                state.mediaRecorder.ondataavailable = (e) => {
                    state.audioChunks.push(e.data);
                };
                
                state.mediaRecorder.onstop = () => {
                    state.isRecording = false;
                    state.recordedAudioBlob = new Blob(state.audioChunks, { type: 'audio/wav' });
                    state.audioChunks = [];
                    stream.getTracks().forEach(track => track.stop()); // Stop the mic
                    render(); // Re-render to show playback
                };
                
                state.mediaRecorder.start();
                render(); // Re-render to show "Stop" button
            } catch (err) {
                console.error("Error starting recording:", err);
                showMessage("Could not start microphone. Please grant permission.", "error");
            }
        }
        
        function handleStopRecording() {
            if (state.mediaRecorder) {
                state.mediaRecorder.stop();
            }
        }
        
        async function handleSaveAudioNote() {
            if (!state.recordedAudioBlob) return;
            
            setState({ loading: true });
            
            const restaurantId = state.currentRestaurantId;
            const description = document.getElementById('audio-description-input').value || `Audio Note - ${new Date().toLocaleString()}`;
            const filePath = `public/${restaurantId}-${new Date().getTime()}.wav`;
            
            try {
                // 1. Upload file to Storage
                const { error: uploadError } = await db.storage
                    .from(AUDIO_BUCKET)
                    .upload(filePath, state.recordedAudioBlob);
                if (uploadError) throw uploadError;
                
                // 2. Save reference to Database
                const { data, error: dbError } = await db.from('audio_notes').insert({
                    restaurant_id: restaurantId,
                    description: description,
                    storage_path: filePath
                }).select();
                if (dbError) throw dbError;
                
                // 3. Update local state
                state.audioNotes.unshift(data[0]);
                state.recordedAudioBlob = null; // Clear recorded blob
                showMessage("Audio note saved!", "success");
                setState({ loading: false }); // Re-renders
                
            } catch (err) {
                console.error("Error saving audio note:", err);
                showMessage(`Error: ${err.message}`, "error");
                setState({ loading: false });
            }
        }
        
        async function playAudioNote(storagePath, buttonElement) {
            const player = document.getElementById(`audio-player-${storagePath.replace(/[^a-zA-Z0-9]/g, '')}`);
            if (!player) return;

            // If player already has a src, just play it
            if (player.src && player.src.startsWith('blob:')) {
                player.play();
                return;
            }

            // Show loading on button
            buttonElement.innerHTML = `<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
            buttonElement.disabled = true;

            try {
                // Get a temporary signed URL to play the file
                const { data, error } = await db.storage
                    .from(AUDIO_BUCKET)
                    .createSignedUrl(storagePath, 3600); // 1 hour expiry
                
                if (error) throw error;
                
                player.src = data.signedUrl;
                player.play();
                
                // Restore button
                buttonElement.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
                buttonElement.disabled = false;

            } catch (err) {
                 console.error("Error playing audio:", err);
                 showMessage(`Error: ${err.message}`, "error");
                 buttonElement.innerHTML = `...`; // Error state
            }
        }
        
        async function deleteAudioNote(noteId, storagePath) {
            // Optimistic local update
            const oldAudioNotes = [...state.audioNotes];
            const newAudioNotes = state.audioNotes.filter(n => n.id != noteId);
            setState({ audioNotes: newAudioNotes });
            
            try {
                // 1. Delete from DB
                const { error: dbError } = await db.from('audio_notes').delete().eq('id', noteId);
                if (dbError) throw dbError;
                
                // 2. Delete from Storage
                const { error: storageError } = await db.storage.from(AUDIO_BUCKET).remove([storagePath]);
                if (storageError) throw storageError;
                
                showMessage("Audio note deleted.", "success");
            } catch (err) {
                console.error("Error deleting audio note:", err);
                showMessage(`Error: ${err.message}`, "error");
                setState({ audioNotes: oldAudioNotes }); // Revert
            }
        }


        // --- Render Functions (generating HTML) ---
        
        // Main render loop
        function render() {
            showLoader(state.loading);
            updateNavActiveState();
            
            let html = '';
            try {
                switch(state.view) {
                    case 'dashboard':
                        html = renderDashboardView();
                        break;
                    case 'pipeline':
                        html = renderPipelineView();
                        break;
                    case 'add':
                        html = renderAddForm();
                        break;
                    case 'search':
                        html = renderSearchView();
                        break;
                    case 'reports':
                        html = renderReportsView();
                        break;
                    case 'detail':
                        html = renderRestaurantDetailView(state.currentRestaurantId);
                        break;
                }
            } catch (err) {
                console.error("Render Error:", err);
                showMessage(`An error occurred while rendering: ${err.message}`, 'error');
                html = `<div class="bg-red-100 text-red-800 p-4 rounded-lg">Render Error. See console.</div>`;
            }
            appContent.innerHTML = html;
        }

        // --- View: Dashboard ---
        function renderDashboardView() {
            const today = new Date().toISOString().split('T')[0];
            const tasksDueToday = state.tasks.filter(t => t.due_date === today && !t.is_completed).length;
            const hotLeads = state.restaurants.filter(r => r.priority === 'Hot' && !['Closed-Won', 'Closed-Lost'].includes(r.deal_stage)).length;
            const totalPipelineValue = state.restaurants
                .filter(r => !['Closed-Won', 'Closed-Lost'].includes(r.deal_stage))
                .reduce((sum, r) => sum + (r.deal_value || 0), 0);
            const dealsWon = state.restaurants.filter(r => r.deal_stage === 'Closed-Won').length;

            const kpiS = [
                { 
                    label: "Pipeline Value", 
                    value: `₹${totalPipelineValue.toLocaleString('en-IN')}`, 
                    icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
                    color: 'blue'
                },
                { 
                    label: "Hot Leads", 
                    value: hotLeads, 
                    icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 18.657A8 8 0 016.343 7.343m11.314 11.314a8 8 0 01-11.314 0m11.314 0L20 20M3 4l2.657 2.657m0 0a8 8 0 010 11.314M6.343 7.343a8 8 0 0111.314 0" /></svg>`,
                    color: 'red'
                },
                { 
                    label: "Tasks Due Today", 
                    value: tasksDueToday, 
                    icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>`,
                    color: 'yellow'
                },
                { 
                    label: "Deals Won", 
                    value: dealsWon, 
                    icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 19c-.879-.438-1.44-1.334-1.44-2.36V11c0-1.026.561-1.922 1.44-2.36l4.066-2.033a.5.5 0 01.485-.06z" /></svg>`,
                    color: 'green'
                }
            ];
            
            const kpiColors = {
                blue: 'primary-bg-light primary-text-dark',
                red: 'bg-red-50 text-red-700',
                yellow: 'bg-yellow-50 text-yellow-700',
                green: 'bg-green-50 text-green-700'
            };

            return `
                <div class="space-y-6">
                    <!-- KPI Cards -->
                    <div class="grid grid-cols-2 gap-4">
                        ${kpiS.map(kpi => {
                            // --- FIX ---
                            // Defensively get color classes with a fallback
                            const colorClassString = kpiColors[kpi.color] || 'bg-slate-50 text-slate-700';
                            const colorClasses = colorClassString.split(' ');
                            const textColor = colorClasses[1] || 'text-slate-700'; // Fallback for split
                            // --- END FIX ---
                            
                            return `
                            <div class="p-4 rounded-2xl shadow-sm bg-white">
                                <div class="mb-2 ${textColor}">${kpi.icon}</div>
                                <div class="text-3xl font-bold text-slate-900">${kpi.value}</div>
                                <div class="text-sm font-medium text-slate-500">${kpi.label}</div>
                            </div>
                            `
                        }).join('')}
                    </div>

                    <!-- Tasks Due Today -->
                    ${renderTasksView(true)}
                    
                </div>
            `;
        }

        // --- View: Pipeline (Kanban) ---
        function renderPipelineView() {
            return `
                <div class="overflow-x-auto flex space-x-4 pb-4" style="scroll-snap-type: x mandatory;">
                    ${DEAL_STAGES.map(stage => renderKanbanColumn(stage)).join('')}
                </div>
            `;
        }
        
        function renderKanbanColumn(stage) {
            const restaurantsInStage = state.restaurants.filter(r => r.deal_stage === stage);
            const valueInStage = restaurantsInStage.reduce((sum, r) => sum + (r.deal_value || 0), 0);
            
            return `
                <div class="kanban-column w-full md:w-80 flex-shrink-0" data-stage="${stage}">
                    <div class="flex justify-between items-center p-2">
                        <h3 class="text-lg font-semibold text-slate-800">${stage} <span class="text-sm font-normal text-slate-500">(${restaurantsInStage.length})</span></h3>
                        <span class="text-sm font-semibold primary-text">₹${valueInStage.toLocaleString('en-IN')}</span>
                    </div>
                    <div 
                        class="kanban-dropzone h-full bg-slate-100 rounded-2xl p-3 space-y-3 border border-transparent" 
                        data-stage="${stage}"
                    >
                        ${restaurantsInStage.length > 0 ? 
                            restaurantsInStage.map(renderKanbanCard).join('') : 
                            `<div class="text-center text-sm text-slate-500 p-4">No deals here.</div>`
                        }
                    </div>
                </div>
            `;
        }
        
        function renderKanbanCard(restaurant) {
            const priorityColors = {
                Hot: 'bg-red-500',
                Warm: 'bg-yellow-500',
                Cold: 'bg-blue-500',
            };
            
            return `
                <div 
                    class="kanban-card bg-white rounded-xl shadow-md p-4 cursor-pointer hover:shadow-lg transition-shadow" 
                    data-id="${restaurant.id}"
                    data-action="view-detail"
                    draggable="true"
                >
                    <div class="flex justify-between items-start">
                        <span class="text-base font-semibold text-slate-800">${restaurant.name}</span>
                        <span class="flex-shrink-0 h-3 w-3 rounded-full ${priorityColors[restaurant.priority] || 'bg-gray-400'}" title="Priority: ${restaurant.priority}"></span>
                    </div>
                    <p class="text-sm text-slate-500 mb-2">${restaurant.contact_person || 'No contact'}</p>
                    <p class="text-sm font-bold primary-text">₹${(restaurant.deal_value || 0).toLocaleString('en-IN')}</p>
                </div>
            `;
        }

        // --- View: Restaurant Detail ---
        function renderRestaurantDetailView(id) {
            const restaurant = state.restaurants.find(r => r.id == id);
            if (!restaurant) return `<p>Restaurant not found.</p>`;
            
            const tasksForRestaurant = state.tasks.filter(t => t.restaurant_id == id);
            const audioNotesForRestaurant = state.audioNotes.filter(a => a.restaurant_id == id);
            
            const cleanPhone = (phone) => phone ? phone.replace(/[^0-9+]/g, '') : '';
            const phone = cleanPhone(restaurant.phone);
            
            // Create links
            const telLink = phone ? `tel:${phone}` : null;
            const waLink = phone ? `https://wa.me/${phone}` : null;
            const pdfText = encodeURIComponent(`Here is the information we discussed: ${PDF_LINK}`);
            const waPdfLink = phone ? `https://wa.me/${phone}?text=${pdfText}` : null;
            
            const actionButton = (href, text, icon, colorClass, isExternal = true) => {
                if (!href) return '';
                const target = isExternal ? `target="_blank" rel="noopener noreferrer"` : '';
                return `
                    <a href="${href}" ${target} class="flex-1 inline-flex items-center justify-center px-4 py-3 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white ${colorClass}">
                        ${icon}
                        ${text}
                    </a>
                `;
            };
            
            const callButton = `
                <a href="${telLink}" class="flex-1 inline-flex items-center justify-center px-4 py-3 border border-slate-300 rounded-lg shadow-sm text-sm font-medium text-slate-700 bg-white hover:bg-slate-50">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>
                    Call
                </a>
            `;

            const infoPill = (label, value, color = 'gray') => {
                const colors = {
                    gray: 'bg-slate-100 text-slate-800',
                    red: 'bg-red-100 text-red-700',
                    yellow: 'bg-yellow-100 text-yellow-800',
                    blue: 'bg-blue-100 text-blue-800',
                    green: 'bg-green-100 text-green-700',
                };
                return `
                    <div class="flex-1 text-center p-3 rounded-xl ${colors[color]}">
                        <span class="text-xs font-semibold uppercase opacity-70">${label}</span>
                        <p class="text-base font-bold">${value || 'N/A'}</p>
                    </div>
                `;
            };
            
            const priorityColor = restaurant.priority === 'Hot' ? 'red' : (restaurant.priority === 'Warm' ? 'yellow' : 'blue');
            const stageColor = ['Closed-Won', 'Proposal'].includes(restaurant.deal_stage) ? 'green' : 'gray';

            return `
                <div class="space-y-6">
                    <!-- Header -->
                    <div>
                        <h2 class="text-3xl font-bold text-slate-900">${restaurant.name}</h2>
                        <p class="text-lg text-slate-600">${restaurant.contact_person || 'No contact person'}</p>
                    </div>
                    
                    <!-- Action Buttons -->
                    ${phone ? `
                        <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                            ${callButton}
                            ${actionButton(waLink, 'WhatsApp', `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448L.057 24zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.433-9.894-9.889-9.895-5.452 0-9.887 4.434-9.889 9.896.001 2.205.738 4.381 2.006 6.041l-1.34 4.888 4.996-1.314z" /></svg>`, 'bg-green-500 hover:bg-green-600')}
                            ${actionButton(waPdfLink, 'Send PDF', `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>`, 'primary-bg hover:opacity-90')}
                        </div>
                    ` : ''}
                    
                    <!-- Deal Info -->
                    <div class="flex gap-3">
                        ${infoPill('Value', `₹${(restaurant.deal_value || 0).toLocaleString('en-IN')}`)}
                        ${infoPill('Priority', restaurant.priority, priorityColor)}
                        ${infoPill('Stage', restaurant.deal_stage, stageColor)}
                    </div>
                    
                    <!-- Details Card -->
                    <div class="bg-white rounded-2xl shadow-sm p-5">
                        <h4 class="text-lg font-semibold text-slate-800 mb-3">Details</h4>
                        <div class="space-y-2 text-sm">
                            <p><strong>Lead Source:</strong> ${restaurant.lead_source || 'N/A'}</p>
                            <p><strong>Keywords:</strong> ${(restaurant.keywords && restaurant.keywords.join(', ')) || 'None'}</p>
                            <h5 class="font-semibold text-slate-800 pt-2">Notes:</h5>
                            <p class="text-slate-700 whitespace-pre-wrap bg-slate-50 p-3 rounded-lg border border-slate-200">${restaurant.notes || 'No notes added.'}</p>
                        </div>
                    </div>
                    
                    <!-- *** NEW: Audio Notes Section *** -->
                    <div class="bg-white rounded-2xl shadow-sm p-5">
                        <h4 class="text-lg font-semibold text-slate-800 mb-4">Audio Notes</h4>
                        
                        <!-- 1. Recorder UI -->
                        <div id="audio-recorder-ui" class="${state.isRecording ? 'recording' : ''} space-y-3 mb-4">
                            <!-- Record/Stop Button -->
                            <button id="record-btn" data-action="${state.isRecording ? 'stop-audio' : 'record-audio'}" class="w-full flex items-center justify-center gap-2 px-4 py-3 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white primary-bg hover:opacity-90 transition-all">
                                <svg xmlns="http://www.w3.org/2000/svg" class="record-btn-icon h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                                <svg xmlns="http://www.w3.org/2000/svg" class="stop-btn-icon h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12v0a9 9 0 01-9 9s-9-3.969-9-9V7.5a9 9 0 0118 0v4.5z" /></svg>
                                <span id="record-btn-text">${state.isRecording ? 'Stop Recording' : 'Record New Audio Note'}</span>
                            </button>
                            
                            <!-- 2. Playback/Save UI (hidden by default) -->
                            ${state.recordedAudioBlob ? `
                                <div id="audio-playback-ui" class="space-y-3 p-3 bg-slate-50 rounded-lg border border-slate-200">
                                    <p class="text-sm font-medium text-slate-700">Review Recording:</p>
                                    <audio id="audio-playback-player" controls src="${URL.createObjectURL(state.recordedAudioBlob)}"></audio>
                                    <input type="text" id="audio-description-input" class="form-input" placeholder="Add a short description...">
                                    <div class="flex gap-3">
                                        <button data-action="discard-audio" class="flex-1 px-4 py-2 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 bg-white hover:bg-slate-50">Discard</button>
                                        <button data-action="save-audio" class="flex-1 px-4 py-2 border border-transparent rounded-lg text-sm font-medium text-white primary-bg hover:opacity-90">Save Note</button>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- 3. List of Saved Notes -->
                        <ul class="space-y-2">
                            ${audioNotesForRestaurant.length > 0 ? 
                                audioNotesForRestaurant.map(renderAudioNoteRow).join('') : 
                                `<li class="text-center text-slate-500 py-4">No audio notes saved.</li>`
                            }
                        </ul>
                    </div>

                    <!-- Tasks Section -->
                    <div class="bg-white rounded-2xl shadow-sm p-5">
                        <h4 class="text-lg font-semibold text-slate-800 mb-4">Tasks</h4>
                        <form id="add-task-form" class="flex flex-col sm:flex-row gap-2 mb-4">
                            <input type="text" name="description" class="form-input flex-1" placeholder="New task description..." required>
                            <input type="date" name="due_date" class="form-input sm:w-auto">
                            <button type="submit" class="px-4 py-3 primary-bg text-white font-semibold rounded-lg shadow-md hover:opacity-90">Add Task</button>
                        </form>
                        <ul class="space-y-2">
                            ${tasksForRestaurant.length > 0 ? 
                                tasksForRestaurant.sort((a,b) => a.is_completed - b.is_completed).map(renderTaskRow).join('') : 
                                `<li class="text-center text-slate-500 py-4">No tasks for this restaurant.</li>`
                            }
                        </ul>
                    </div>
                    
                    <!-- Delete Button -->
                    <div class="text-center pt-4">
                        <button data-action="delete-restaurant" data-id="${restaurant.id}" class="text-sm font-medium text-red-600 hover:text-red-800">
                            Delete Restaurant
                        </button>
                    </div>
                </div>
            `;
        }
        
        // --- View: Add/Edit Form ---
        function renderAddForm() {
            return `
                <div class="bg-white p-5 md:p-8 rounded-2xl shadow-xl max-w-2xl mx-auto">
                    <h2 class="text-3xl font-bold text-slate-900 mb-6">Add New Deal</h2>
                    <form id="add-restaurant-form" class="space-y-5">
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div>
                                <label for="name" class="form-label">Restaurant Name <span class="text-red-500">*</span></label>
                                <input type="text" id="name" name="name" class="form-input" required>
                            </div>
                            <div>
                                <label for="contact_person" class="form-label">Contact Person</label>
                                <input type="text" id="contact_person" name="contact_person" class="form-input">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div>
                                <label for="phone" class="form-label">Contact Phone</label>
                                <input type="tel" id="phone" name="phone" class="form-input">
                            </div>
                            <div>
                                <label for="deal_value" class="form-label">Deal Value (₹)</label>
                                <input type="number" id="deal_value" name="deal_value" class="form-input" placeholder="e.g. 50000">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                            <div>
                                <label for="deal_stage" class="form-label">Stage</label>
                                <select id="deal_stage" name="deal_stage" class="form-input">
                                    ${DEAL_STAGES.map(s => `<option value="${s}">${s}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label for="priority" class="form-label">Priority</label>
                                <select id="priority" name="priority" class="form-input">
                                    ${PRIORITIES.map(p => `<option value="${p}">${p}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label for="lead_source" class="form-label">Lead Source</label>
                                <select id="lead_source" name="lead_source" class="form-input">
                                    ${LEAD_SOURCES.map(s => `<option value="${s}">${s}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label for="keywords" class="form-label">Keywords (comma-separated)</label>
                            <input type="text" id="keywords" name="keywords" class="form-input" placeholder="e.g. discount, software, interested">
                        </div>

                        <div>
                            <label for="notes" class="form-label">Notes</label>
                            <textarea id="notes" name="notes" rows="5" class="form-input" placeholder="Enter deal details, follow-up actions, etc."></textarea>
                        </div>
                        
                        <div class="text-right pt-2">
                            <button type="submit" class="w-full md:w-auto px-8 py-3 primary-bg text-white font-semibold rounded-lg shadow-md hover:opacity-90 transition-opacity">
                                Save Restaurant
                            </button>
                        </div>
                    </form>
                </div>
            `;
        }
        
        // --- View: All Tasks (for Dashboard) ---
        function renderTasksView(isDashboard = false) {
            const today = new Date().toISOString().split('T')[0];
            let tasks;
            
            if (isDashboard) {
                tasks = state.tasks.filter(t => t.due_date === today && !t.is_completed);
            } else {
                // This is now only for the dashboard, but keeping logic just in case
                tasks = state.tasks
                    .filter(t => !t.is_completed)
                    .sort((a,b) => (a.due_date || '9999').localeCompare(b.due_date || '9999'));
            }
            
            const title = "Tasks Due Today";
            const emptyMessage = "No tasks due today. Well done!";

            return `
                <div>
                    <h3 class="text-xl font-semibold mb-4 text-slate-800">${title}</h3>
                    <div class="bg-white rounded-2xl shadow-sm p-4">
                        <ul class="divide-y divide-slate-100">
                            ${tasks.length > 0 ? 
                                tasks.map(renderTaskRow).join('') : 
                                `<li class="text-center text-slate-500 py-4">${emptyMessage}</li>`
                            }
                        </ul>
                    </div>
                </div>
            `;
        }

        // --- View: Search ---
        function renderSearchView() {
            const filtered = state.restaurants.filter(r =>
                r.name.toLowerCase().includes(state.searchTerm) ||
                (r.contact_person && r.contact_person.toLowerCase().includes(state.searchTerm)) ||
                (r.notes && r.notes.toLowerCase().includes(state.searchTerm)) ||
                (r.keywords && r.keywords.some(k => k.toLowerCase().includes(state.searchTerm)))
            );
            
            return `
                <div class="space-y-6">
                    <form onsubmit="return false;">
                        <input
                            type="search"
                            id="search-input"
                            name="search"
                            value="${state.searchTerm}"
                            class="w-full px-5 py-4 border border-slate-200 rounded-xl shadow-sm text-lg bg-white"
                            placeholder="Type to search..."
                        />
                    </form>
                    
                    <div class="space-y-4">
                    ${filtered.length > 0 ?
                        filtered.map(renderRestaurantSearchCard).join('') :
                        (state.searchTerm ? `<p class="text-center text-slate-500 py-8">No results found for "${state.searchTerm}".</p>` : `<p class="text-center text-slate-500 py-8">Search for deals by name, contact, or keyword.</p>`)
                    }
                    </div>
                </div>
            `;
        }
        
        function renderRestaurantSearchCard(restaurant) {
            return `
                <div class="bg-white rounded-xl shadow-md p-4 cursor-pointer hover:bg-slate-50" data-action="view-detail" data-id="${restaurant.id}">
                    <span class="text-xs font-medium primary-text-dark primary-bg-light px-2 py-1 rounded-full">${restaurant.deal_stage}</span>
                    <h4 class="text-lg font-semibold text-slate-800 mt-2">${restaurant.name}</h4>
                    <p class="text-sm text-slate-600">${restaurant.contact_person || 'No contact'}</p>
                    <p class="text-sm font-semibold primary-text mt-1">₹${(restaurant.deal_value || 0).toLocaleString('en-IN')}</p>
                </div>
            `;
        }
        
        // --- View: Reports (NEW) ---
        function renderReportsView() {
            const totalDeals = state.restaurants.length;
            const wonDeals = state.restaurants.filter(r => r.deal_stage === 'Closed-Won');
            const lostDeals = state.restaurants.filter(r => r.deal_stage === 'Closed-Lost');
            const openDeals = totalDeals - wonDeals.length - lostDeals.length;
            
            const winRate = totalDeals > 0 && (wonDeals.length + lostDeals.length) > 0 ? ((wonDeals.length / (wonDeals.length + lostDeals.length)) * 100).toFixed(0) : 0;
            const totalWonValue = wonDeals.reduce((sum, r) => sum + r.deal_value, 0);
            const avgDealValue = wonDeals.length > 0 ? (totalWonValue / wonDeals.length) : 0;

            const stagesData = DEAL_STAGES.map(stage => {
                const deals = state.restaurants.filter(r => r.deal_stage === stage);
                return {
                    name: stage,
                    count: deals.length,
                    value: deals.reduce((sum, r) => sum + r.deal_value, 0)
                };
            });
            
            const maxCount = Math.max(1, ...stagesData.map(s => s.count));
            const maxValue = Math.max(1, ...stagesData.filter(s => !['Closed-Won', 'Closed-Lost'].includes(s.name)).map(s => s.value));

            return `
                <div class="space-y-6">
                    <h2 class="text-3xl font-bold text-slate-900">Reports</h2>
                    
                    <!-- Key Stats -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        ${renderStatCard("Total Deals", totalDeals)}
                        ${renderStatCard("Open Deals", openDeals)}
                        ${renderStatCard("Win Rate", `${winRate}%`)}
                        ${renderStatCard("Avg. Deal", `₹${Math.round(avgDealValue).toLocaleString('en-IN')}`)}
                    </div>
                    
                    <!-- Chart: Deals by Stage -->
                    <div class="bg-white rounded-2xl shadow-sm p-5">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">Deals by Stage (Count)</h3>
                        <div class="flex h-48 gap-3 items-end">
                            ${stagesData.map(stage => `
                                <div class="flex-1 flex flex-col items-center">
                                    <div class="chart-bar w-full h-full flex items-end">
                                        <div class="chart-bar-fill w-full" style="height: ${(stage.count / maxCount) * 100}%"></div>
                                    </div>
                                    <span class="text-xs font-medium text-slate-500 mt-2">${stage.name}</span>
                                    <span class="text-sm font-bold text-slate-700">${stage.count}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Chart: Value by Stage -->
                    <div class="bg-white rounded-2xl shadow-sm p-5">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">Value by Stage (Open)</h3>
                        <div class="flex h-48 gap-3 items-end">
                            ${stagesData.filter(s => !['Closed-Won', 'Closed-Lost'].includes(s.name)).map(stage => `
                                <div class="flex-1 flex flex-col items-center">
                                    <div class="chart-bar w-full h-full flex items-end">
                                        <div class="chart-bar-fill w-full" style="height: ${(stage.value / maxValue) * 100}%"></div>
                                    </div>
                                    <span class="text-xs font-medium text-slate-500 mt-2">${stage.name}</span>
                                    <span class="text-sm font-bold text-slate-700">₹${(stage.value / 1000).toFixed(0)}k</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderStatCard(label, value) {
            return `
                <div class="bg-white rounded-2xl shadow-sm p-4">
                    <div class="text-3xl font-bold text-slate-900">${value}</div>
                    <div class="text-sm font-medium text-slate-500">${label}</div>
                </div>
            `;
        }


        // --- Child Component: Task Row ---
        function renderTaskRow(task) {
            const restaurant = state.restaurants.find(r => r.id === task.restaurant_id);
            const isOverdue = !task.is_completed && task.due_date && task.due_date < new Date().toISOString().split('T')[0];
            
            return `
                <li class="py-3 flex items-center justify-between" data-task-id="${task.id}">
                    <div class="flex items-center flex-1 min-w-0">
                        <input 
                            type="checkbox" 
                            class="h-5 w-5 rounded primary-text border-slate-300 flex-shrink-0"
                            data-action="toggle-task"
                            data-id="${task.id}"
                            ${task.is_completed ? 'checked' : ''}
                        >
                        <div class="ml-3 min-w-0">
                            <p class="text-sm font-medium text-slate-800 truncate ${task.is_completed ? 'line-through text-slate-400' : ''}">
                                ${task.description}
                            </p>
                            <div class="text-xs text-slate-500 space-x-2 truncate">
                                ${restaurant ? `<span class="font-medium">${restaurant.name}</span>` : ''}
                                ${task.due_date ? 
                                    `<span class="font-medium ${isOverdue ? 'text-red-500' : 'text-slate-600'}">
                                        ${formatDate(task.due_date, { month: 'short', day: 'numeric', timeZone: 'UTC' })}
                                    </span>` 
                                    : ''
                                }
                            </div>
                        </div>
                    </div>
                    <button data-action="delete-task" data-id="${task.id}" class="text-slate-400 hover:text-red-500 ml-2 flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </li>
            `;
        }
        
        // --- Child Component: Audio Note Row (NEW) ---
        function renderAudioNoteRow(note) {
            const playerKey = note.storage_path.replace(/[^a-zA-Z0-9]/g, '');
            return `
                <li class="py-3 flex items-center justify-between" data-note-id="${note.id}">
                    <div class="flex items-center min-w-0">
                        <button 
                            data-action="play-audio" 
                            data-path="${note.storage_path}"
                            class="flex-shrink-0 h-10 w-10 rounded-full primary-bg text-white flex items-center justify-center shadow-lg hover:opacity-90"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        </button>
                        <div class="ml-3 min-w-0">
                            <p class="text-sm font-medium text-slate-800 truncate">
                                ${note.description || 'Audio Note'}
                            </p>
                            <span class="text-xs text-slate-500">
                                ${formatDate(note.created_at, { month: 'short', day: 'numeric' })}
                            </span>
                            <!-- Hidden player, loaded on demand -->
                            <audio id="audio-player-${playerKey}"></audio>
                        </div>
                    </div>
                    <button 
                        data-action="delete-audio" 
                        data-id="${note.id}" 
                        data-path="${note.storage_path}" 
                        class="text-slate-400 hover:text-red-500 ml-2 flex-shrink-0"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </li>
            `;
        }
        
        // --- Helper to format dates ---
        function formatDate(dateString, options = {}) {
            if (!dateString) return 'N/A';
            const defaultOptions = {
                day: 'numeric', month: 'short', year: 'numeric',
            };
            const finalOptions = { ...defaultOptions, ...options };
            
            // Handle (YYYY-MM-DD)
            if (dateString.length === 10) {
                const [year, month, day] = dateString.split('-');
                const date = new Date(year, month - 1, day);
                return date.toLocaleDateString('en-US', finalOptions);
            }
            // Handle full timestamp
            return new Date(dateString).toLocaleString('en-US', finalOptions);
        }

        // --- App Initialization ---
        function init() {
            // Check for HTTPS (required for audio recording)
            if (window.location.protocol !== 'https:S' && window.location.hostname !== 'localhost') {
                showMessage("Audio recording requires a secure (https://) connection.", "error");
            }
            setupNav();
            setupAppListeners();
            fetchAllData(); // Load initial data
        }
        
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>

